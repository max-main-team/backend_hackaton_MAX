name: Deploy Backend

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    env:
      REGISTRY: ghcr.io
      TARGET_DIR: /opt/backend
      SSH_HOST: ${{ secrets.SERVER_HOST }}
      SSH_USER: ${{ secrets.SERVER_USER }}
      SSH_KEY:  ${{ secrets.SERVER_SSH_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # === формируем безопасное имя образа GHCR (lowercase, '_' -> '-') ===
      - name: Compute safe image name
        shell: bash
        run: |
          REPO_NAME="${GITHUB_REPOSITORY##*/}"         # напр. backend_hackaton_MAX
          OWNER_NAME="${GITHUB_REPOSITORY_OWNER}"      # напр. max-main-team

          SAFE_NAME=$(echo "$REPO_NAME"  | tr '[:upper:]' '[:lower:]' | tr '_' '-')
          OWNER_SAFE=$(echo "$OWNER_NAME" | tr '[:upper:]' '[:lower:]')

          IMAGE_REPO="ghcr.io/${OWNER_SAFE}/${SAFE_NAME}/app"
          echo "IMAGE=${IMAGE_REPO}:latest" >> "$GITHUB_ENV"
          echo "IMAGE_SHA=${IMAGE_REPO}:${GITHUB_SHA}" >> "$GITHUB_ENV"

          echo "Using IMAGE=${IMAGE}"
          echo "Using IMAGE_SHA=${IMAGE_SHA}"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & Push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE }}
            ${{ env.IMAGE_SHA }}

      # Упаковываем нужные файлы для сервера (без .env)
      - name: Create deploy package
        shell: bash
        run: |
          mkdir -p bundle
          cp docker-compose.yml bundle/
          cp Dockerfile bundle/
          if [ -d db ]; then cp -r db bundle/; fi
          tar -czf bundle.tgz -C bundle .

      - name: Upload package via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          source: "bundle.tgz"
          target: "/tmp"

      - name: Deploy on server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          script_stop: true
          script: |
            set -e
            sudo mkdir -p "${{ env.TARGET_DIR }}"
            sudo tar -xzf /tmp/bundle.tgz -C "${{ env.TARGET_DIR }}"
            cd "${{ env.TARGET_DIR }}"

            # при необходимости логин в GHCR:
            # echo "${{ secrets.GHCR_PAT }}" | sudo docker login ghcr.io -u "${{ github.actor }}" --password-stdin

            IMAGE="${{ env.IMAGE }}" sudo -E docker compose pull --ignore-pull-failures
            IMAGE="${{ env.IMAGE }}" sudo -E docker compose up -d
            sudo docker compose ps
      
