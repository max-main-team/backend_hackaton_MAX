name: Deploy Backend

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    env:
      REGISTRY: ghcr.io
      # repo в lower и с заменой '_' -> '-'
      IMAGE_NAME: ${{ toLower(replace(github.repository, '_', '-')) }}/app
      IMAGE: ghcr.io/${{ env.IMAGE_NAME }}:latest
      TARGET_DIR: /opt/backend
      SSH_HOST: ${{ secrets.SERVER_HOST }}
      SSH_USER: ${{ secrets.SERVER_USER }}
      SSH_KEY:  ${{ secrets.SERVER_SSH_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Compute safe image name
        run: |
          # взять имя репозитория: owner/repo
          REPO="${GITHUB_REPOSITORY}"
          # оставить только repo
          REPO_NAME="${REPO##*/}"
          
          # привести к lowercase и заменить "_" → "-"
          SAFE_NAME=$(echo "$REPO_NAME" | tr '[:upper:]' '[:lower:]' | tr '_' '-')
          
          # сформировать полный путь к образу
          IMAGE="ghcr.io/${GITHUB_REPOSITORY_OWNER,,}/${SAFE_NAME}/app:latest"
          
          echo "IMAGE_NAME=$SAFE_NAME" >> $GITHUB_ENV
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV
          
          echo "Using image: $IMAGE"
          

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & Push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE }}
            ghcr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Create deploy package
        run: |
          mkdir -p bundle
          cp docker-compose.yml bundle/
          if [ -d db ]; then cp -r db bundle/; fi
          # соберём .env для compose (добавим IMAGE)
          {
            if [ -n "${{ secrets.ENV_FILE }}" ]; then
              printf "%s\n" "${{ secrets.ENV_FILE }}"
            fi
            echo "IMAGE=${IMAGE}"
          } > bundle/.env
          tar -czf bundle.tgz -C bundle .

      - name: Upload package via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          source: "bundle.tgz"
          target: "/tmp"

      - name: Deploy on server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          script: |
            set -e
            sudo mkdir -p "$TARGET_DIR"
            sudo tar -xzf /tmp/bundle.tgz -C "$TARGET_DIR"
            cd "$TARGET_DIR"
            sudo docker compose pull --ignore-pull-failures
            sudo docker compose up -d
            sudo docker compose ps
